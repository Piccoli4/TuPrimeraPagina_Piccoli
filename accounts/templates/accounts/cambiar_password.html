{% extends 'base.html' %}
{% load static %}

{% block title %}Cambiar Contrase√±a - Pilates Gravity{% endblock %}

{% block content %}
    <div class="cambiar-password-container">
        <div class="cambiar-password-header">
            <div class="header-content">
                <h1 class="page-title">
                    Cambiar Contrase√±a
                </h1>
                <p class="page-subtitle">
                    Actualiza tu contrase√±a para mantener tu cuenta segura
                </p>
            </div>
        </div>

        <div class="cambiar-password-content">
            <div class="form-container">
                <div class="form-header">
                    <div class="security-icon">
                        <i class="icon-shield"></i>
                    </div>
                    <h2>Seguridad de tu Cuenta</h2>
                    <p>Introduce tu contrase√±a actual y la nueva contrase√±a que deseas utilizar.</p>
                </div>

                <form method="post" class="password-form" novalidate>
                    {% csrf_token %}
                    
                    <!-- Mostrar errores generales del formulario -->
                    {% if form.non_field_errors %}
                        <div class="alert alert-error">
                            {% for error in form.non_field_errors %}
                                <p><i class="icon-warning"></i> {{ error }}</p>
                            {% endfor %}
                        </div>
                    {% endif %}

                    <!-- Campo Contrase√±a Actual -->
                    <div class="form-group">
                        <label for="{{ form.password_actual.id_for_label }}" class="form-label">
                            {{ form.password_actual.label }}
                            <span class="required">*</span>
                        </label>
                        <div class="input-wrapper">
                            {{ form.password_actual }}
                            <button type="button" class="toggle-password" data-target="{{ form.password_actual.id_for_label }}">
                                <i class="icon-eye"></i>
                            </button>
                        </div>
                        {% if form.password_actual.errors %}
                            <div class="field-error">
                                {% for error in form.password_actual.errors %}
                                    <span><i class="icon-warning"></i> {{ error }}</span>
                                {% endfor %}
                            </div>
                        {% endif %}
                    </div>

                    <!-- Campo Nueva Contrase√±a -->
                    <div class="form-group">
                        <label for="{{ form.password_nueva.id_for_label }}" class="form-label">
                            {{ form.password_nueva.label }}
                            <span class="required">*</span>
                        </label>
                        <div class="input-wrapper">
                            {{ form.password_nueva }}
                            <button type="button" class="toggle-password" data-target="{{ form.password_nueva.id_for_label }}">
                                <i class="icon-eye"></i>
                            </button>
                        </div>
                        <div class="password-strength">
                            <div class="strength-bar">
                                <div class="strength-fill"></div>
                            </div>
                            <span class="strength-text">Seguridad: <span class="strength-level">-</span></span>
                        </div>
                        {% if form.password_nueva.help_text %}
                            <div class="field-help">
                                <i class="icon-info"></i> {{ form.password_nueva.help_text }}
                            </div>
                        {% endif %}
                        {% if form.password_nueva.errors %}
                            <div class="field-error">
                                {% for error in form.password_nueva.errors %}
                                    <span><i class="icon-warning"></i> {{ error }}</span>
                                {% endfor %}
                            </div>
                        {% endif %}
                    </div>

                    <!-- Campo Confirmar Nueva Contrase√±a -->
                    <div class="form-group">
                        <label for="{{ form.password_confirmacion.id_for_label }}" class="form-label">
                            {{ form.password_confirmacion.label }}
                            <span class="required">*</span>
                        </label>
                        <div class="input-wrapper">
                            {{ form.password_confirmacion }}
                            <button type="button" class="toggle-password" data-target="{{ form.password_confirmacion.id_for_label }}">
                                <i class="icon-eye"></i>
                            </button>
                        </div>
                        <div class="password-match">
                            <span class="match-indicator">
                                <i class="icon-check"></i> Las contrase√±as coinciden
                            </span>
                        </div>
                        {% if form.password_confirmacion.errors %}
                            <div class="field-error">
                                {% for error in form.password_confirmacion.errors %}
                                    <span><i class="icon-warning"></i> {{ error }}</span>
                                {% endfor %}
                            </div>
                        {% endif %}
                    </div>

                    <!-- Consejos de Seguridad -->
                    <div class="security-tips">
                        <h4><i class="icon-info"></i> Consejos para una contrase√±a segura:</h4>
                        <ul>
                            <li>Al menos 8 caracteres de longitud</li>
                            <li>Combina letras may√∫sculas y min√∫sculas</li>
                            <li>Incluye n√∫meros y s√≠mbolos</li>
                            <li>Evita informaci√≥n personal obvia</li>
                        </ul>
                    </div>

                    <!-- Botones de Acci√≥n -->
                    <div class="password-form-actions">
                        <button type="submit" class="password-btn password-btn-primary">
                            <i class="icon-save"></i>
                            Cambiar Contrase√±a
                        </button>
                        <a href="{% url 'accounts:profile' %}" class="password-btn password-btn-secondary">
                            <i class="icon-arrow-left"></i>
                            Cancelar
                        </a>
                    </div>
                </form>
            </div>

            <!-- Panel de Informaci√≥n Adicional -->
            <div class="info-panel">
                <div class="info-card">
                    <div class="info-icon">
                        <i class="icon-shield-check"></i>
                    </div>
                    <h3>Seguridad de tu Cuenta</h3>
                    <p>
                        Tu contrase√±a es la primera l√≠nea de defensa para proteger tu cuenta. 
                        Te recomendamos cambiarla regularmente y no compartirla con nadie.
                    </p>
                    <ul class="security-features">
                        <li><i class="icon-check"></i> Encriptaci√≥n de datos</li>
                        <li><i class="icon-check"></i> Autenticaci√≥n segura</li>
                        <li><i class="icon-check"></i> Protecci√≥n de privacidad</li>
                    </ul>
                </div>

                <div class="info-card">
                    <div class="info-icon warning">
                        <i class="icon-alert"></i>
                    </div>
                    <h3>¬øOlvidaste tu Contrase√±a?</h3>
                    <p>
                        Si has olvidado tu contrase√±a actual, puedes solicitar un 
                        restablecimiento por correo electr√≥nico.
                    </p>
                    <a href="#" class="password-btn password-btn-outline">
                        <i class="icon-mail"></i>
                        Restablecer Contrase√±a
                    </a>
                </div>
            </div>
        </div>
    </div>

    <!-- Iconos CSS (Font Awesome simulado con CSS) -->
    <style>
        .icon-shield::before { content: "üõ°Ô∏è"; }
        .icon-shield-check::before { content: "‚úÖ"; }
        .icon-warning::before { content: "‚ö†Ô∏è"; }
        .icon-eye::before { content: "üëÅÔ∏è"; }
        .icon-info::before { content: "‚ÑπÔ∏è"; }
        .icon-check::before { content: "‚úì"; }
        .icon-save::before { content: "üíæ"; }
        .icon-arrow-left::before { content: "‚Üê"; }
        .icon-alert::before { content: "üö®"; }
        .icon-mail::before { content: "‚úâÔ∏è"; }
    </style>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Toggle para mostrar/ocultar contrase√±as
            const toggleButtons = document.querySelectorAll('.toggle-password');
            toggleButtons.forEach(button => {
                button.addEventListener('click', function(e) {
                    e.preventDefault();
                    const targetId = this.getAttribute('data-target');
                    const input = document.getElementById(targetId);
                    const icon = this.querySelector('i');
                    
                    if (input.type === 'password') {
                        input.type = 'text';
                        icon.style.opacity = '0.7';
                    } else {
                        input.type = 'password';
                        icon.style.opacity = '1';
                    }
                });
            });

            // Validaci√≥n de fuerza de contrase√±a
            const passwordInput = document.getElementById('{{ form.password_nueva.id_for_label }}');
            const strengthBar = document.querySelector('.strength-fill');
            const strengthText = document.querySelector('.strength-level');
            
            if (passwordInput) {
                passwordInput.addEventListener('input', function() {
                    const password = this.value;
                    const strength = calculatePasswordStrength(password);
                    updateStrengthIndicator(strength, strengthBar, strengthText);
                });
            }

            // Validaci√≥n de coincidencia de contrase√±as
            const confirmInput = document.getElementById('{{ form.password_confirmacion.id_for_label }}');
            const matchIndicator = document.querySelector('.password-match');
            
            if (confirmInput && passwordInput) {
                function checkPasswordMatch() {
                    const password = passwordInput.value;
                    const confirm = confirmInput.value;
                    
                    if (confirm === '') {
                        matchIndicator.style.display = 'none';
                        return;
                    }
                    
                    matchIndicator.style.display = 'block';
                    
                    if (password === confirm) {
                        matchIndicator.classList.remove('no-match');
                        matchIndicator.classList.add('match');
                        matchIndicator.innerHTML = '<span class="match-indicator"><i class="icon-check"></i> Las contrase√±as coinciden</span>';
                    } else {
                        matchIndicator.classList.remove('match');
                        matchIndicator.classList.add('no-match');
                        matchIndicator.innerHTML = '<span class="match-indicator"><i class="icon-warning"></i> Las contrase√±as no coinciden</span>';
                    }
                }
                
                passwordInput.addEventListener('input', checkPasswordMatch);
                confirmInput.addEventListener('input', checkPasswordMatch);
            }

            function calculatePasswordStrength(password) {
                let score = 0;
                
                if (password.length >= 8) score += 1;
                if (password.length >= 12) score += 1;
                if (/[a-z]/.test(password)) score += 1;
                if (/[A-Z]/.test(password)) score += 1;
                if (/[0-9]/.test(password)) score += 1;
                if (/[^A-Za-z0-9]/.test(password)) score += 1;
                
                return score;
            }

            function updateStrengthIndicator(strength, bar, text) {
                const levels = ['Muy d√©bil', 'D√©bil', 'Regular', 'Buena', 'Fuerte', 'Muy fuerte'];
                const colors = ['#ff4444', '#ff8800', '#ffaa00', '#88cc00', '#44cc00', '#00aa44'];
                
                if (strength === 0) {
                    bar.style.width = '0%';
                    text.textContent = '-';
                    return;
                }
                
                const percentage = (strength / 6) * 100;
                bar.style.width = percentage + '%';
                bar.style.backgroundColor = colors[strength - 1];
                text.textContent = levels[strength - 1];
                text.style.color = colors[strength - 1];
            }
        });
    </script>
{% endblock %}